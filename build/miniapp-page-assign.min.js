"use strict";var proxyType="Proxy";var proxyKeys=[];var proxyVal="";var setData=function setData(self){if(!self){return}if(!self.data){self.data={}}if(self.setData){var data={};var keysStr=proxyKeys.join(".");data[keysStr]=proxyVal;self.setData(data);proxyKeys=[];proxyVal=""}};var addProxy=function addProxy(obj,self){if(typeof Proxy=="undefined"){console.warn("The Proxy is not supported, try to upgrade system.");console.warn("If use android, upgrade system version up 4.4.4");console.warn("If use IPhone, upgrade system version up 10.2");return null}return new Proxy(obj,{get:function get(target,key){if(target[key]&&Object.prototype.toString.call(target[key])=="[object Object]"){proxyKeys.push(key);return addProxy(target[key],self)}else{proxyKeys=[];return target[key]}},set:function set(target,key,value){target[key]=value;proxyKeys.push(key);proxyVal=value;setData(self);return true}})};var addProperty=function addProperty(data,self){if(typeof Object.defineProperties=="undefined"){console.warn("The Object.defineProperties is not supported, try to upgrade wechat.");wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。"});return null}var _data=JSON.parse(JSON.stringify(data));var initProp=function initProp(obj,name){return{configurable:true,enumerable:true,get:function get(){if(Object.prototype.toString.call(obj[name])=="[object Object]"){var preSave=JSON.stringify(obj[name]);setTimeout(function(){if(preSave!==JSON.stringify(obj[name])){proxyKeys[0]=name;proxyVal=obj[name];setData(self)}},0)}return obj[name]},set:function set(val){obj[name]=val;proxyKeys[0]=name;proxyVal=obj[name];setData(self)}}};var defineProperties=function defineProperties(obj,s_obj,obj_name){var props={};Object.keys(obj).forEach(function(key){props[key]=initProp(s_obj,key)});return Object.defineProperties(obj,props)};defineProperties(_data,data);return _data};var setLaunchInfo=function setLaunchInfo(launchInfo){wx.$launchInfo=launchInfo};var setRoute=function setRoute(){var routeInfo=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{query:{}};var self=arguments[1];var router=[];var currentPages=getCurrentPages();if(currentPages.length>0){currentPages.forEach(function(page){router.push({query:page.options,path:page.route})})}if(router.length==0){wx.$route={}}if(router.length==1){wx.$route=router[0]}else if(router.length>1){var fromPage=router[router.length-2];wx.$route=router[router.length-1];wx.$route.fromQuery=fromPage.query;wx.$route.fromPath=fromPage.path}Object.keys(wx.$launchInfo).forEach(function(key){wx.$route[key]=wx.$launchInfo[key]});Object.keys(routeInfo).forEach(function(key){wx.$route[key]=routeInfo[key]});if(self){self.$route=wx.$route}};var getPagePostion=function getPagePostion(){var page=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"pages/index/index";var pagePosition=wx.getStorageSync("pagePosition");if(!pagePosition[page]){return{}}return pagePosition[page]};var updatePagePosition=function updatePagePosition(){var page=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"pages/index/index";var init=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var pagePosition=wx.getStorageSync("pagePosition");if(!pagePosition){pagePosition={}}if(!pagePosition[page]){pagePosition[page]={}}if(init){pagePosition[page]["scrollTop"]=0;pagePosition[page]["maxScrollTop"]=0;wx.setStorageSync("pagePosition",pagePosition)}else{wx.createSelectorQuery().selectViewport().scrollOffset(function(position){var scrollTop=position.scrollTop;var maxScrollTop=pagePosition[page]["maxScrollTop"]||0;if(scrollTop>maxScrollTop){maxScrollTop=scrollTop}pagePosition[page]["scrollTop"]=scrollTop;pagePosition[page]["maxScrollTop"]=maxScrollTop;wx.setStorageSync("pagePosition",pagePosition)}).exec()}};var scrollToPosition=function scrollToPosition(){var page=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"pages/index/index";wx.pageScrollTo({scrollTop:getPagePostion(page).scrollTop})};var checkVersion=function checkVersion(){if(wx.getUpdateManager){var updateManager=wx.getUpdateManager();updateManager.onUpdateReady(function(readyCb){wx.showModal({title:"更新提示",content:"新版本已经准备好，是否重启应用？",success:function success(res){if(res.confirm){updateManager.applyUpdate()}}})});updateManager.onUpdateFailed(function(failedCb){console.warn("Present version is not now but upgrade fail.")})}else{console.warn("Please update miniapp version more than 1.9.90")}};var pageAssign=function pageAssign(config){var _this=this;if(!config)config={};if(Object.prototype.toString.call(config.data)!="[object Object]"){config.data={}}if(Object.prototype.toString.call(config.methods)!="[object Object]"){config.methods={}}if(!Array.isArray(config.mixin)){config.mixin=[]}var callbackList=["onLoad","onShow","onReady","onHide","onUnload","onPullDownRefresh","onReachBottom","onShareAppMessage","onPageScroll","onTabItemTap"];var glbalMethods=["onModel","getPagePostion","updatePagePosition","scrollToPosition","checkVersion"];if(config.mixin.length>0){config.mixin.forEach(function(mixItem){if(Object.prototype.toString.call(mixItem.data)=="[object Object]"){config.data=Object.assign(config.data,mixItem.data)}if(Object.prototype.toString.call(mixItem.methods)=="[object Object]"){config.methods=Object.assign(config.methods,mixItem.methods)}})}var forbidMethods=[].concat(callbackList).concat(glbalMethods);Object.keys(config).forEach(function(item){if(item=="data"){_this.data=config["data"]}else if(item=="methods"){Object.keys(config[item]).forEach(function(method){if(forbidMethods.indexOf(method)!=-1){console.error("method ["+method+"] is a reserved word")}else{_this[method]=config[item][method]}})}else if(item=="mixin"){}else{if(forbidMethods.indexOf(item)!=-1){_this["_"+item]=config[item]}else{console.warn("method ["+item+"] is suggest register in methods");_this[item]=config[item]}}});this.onLoad=function(options){this.$data=addProxy(this.data,this);proxyType="Proxy";if(!this.$data){this.$data=addProperty(this.data,this);proxyType="defineProperties"}if(!this.$data){this.$data={}}this.setRoute({query:options},this);if(this._onLoad){this._onLoad(options)}};this.onShow=function(){this.setRoute({query:this.options,path:this.route});if(this._onShow){this._onShow()}};this.onReady=function(){if(this._onReady){this._onReady()}};this.onHide=function(){if(this._onHide){this._onHide()}};this.onUnload=function(){if(this._onUnload){this._onUnload()}};this.onPullDownRefresh=function(){if(this._onPullDownRefresh){this._onPullDownRefresh()}};this.onReachBottom=function(){if(this._onReachBottom){this._onReachBottom()}};this.onShareAppMessage=function(obj){if(this._onShareAppMessage){return this._onShareAppMessage(obj)}else{return{title:"这是一个分享标题",path:"/pages/index/index"}}};this.onPageScroll=function(obj){updatePagePosition(this.$route.pagePath);if(this._onPageScroll){this._onPageScroll(obj)}};this.onTabItemTap=function(obj){if(this._onTabItemTap){this._onTabItemTap(obj)}};this.onModel=function(event){if(!event){return}var key=event.currentTarget.dataset.key;var value=event.currentTarget.dataset.value;if(value==undefined){value=event.detail.value}if(!key){return}if(proxyType=="Proxy"){this.$data[key]=value}else{proxyKeys=key.split(".");proxyVal=value;setData(this)}};this.setRoute=setRoute;this.getPagePostion=getPagePostion;this.updatePagePosition=updatePagePosition;this.scrollToPosition=scrollToPosition;this.checkVersion=checkVersion};module.exports={setLaunchInfo:setLaunchInfo,setRoute:setRoute,pageAssign:pageAssign,checkVersion:checkVersion};